#!/bin/bash
# Plane Vulnerability Scanning Script
# Usage: ./vulnerability-scan.sh

set -e

SCAN_DIR="Z:/plane-data/security-scans"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
REPORT_FILE="$SCAN_DIR/vulnerability_report_$TIMESTAMP.txt"

echo "Starting vulnerability scan at $(date)"
mkdir -p "$SCAN_DIR"

echo "Plane Security Scan Report - $(date)" > "$REPORT_FILE"
echo "=================================" >> "$REPORT_FILE"

# Python package scan
if command -v pip >/dev/null 2>&1; then
    echo "🔍 Scanning Python packages..."
    if ! command -v safety >/dev/null 2>&1; then
        pip install safety
    fi
    echo "Python Vulnerabilities:" >> "$REPORT_FILE"
    safety check -r apiserver/requirements/base.txt >> "$REPORT_FILE" 2>&1 || true
fi

# Node.js package scan  
if command -v npm >/dev/null 2>&1 && [ -f "web/package.json" ]; then
    echo "🔍 Scanning Node.js packages..."
    echo "Node.js Vulnerabilities:" >> "$REPORT_FILE"
    cd web && npm audit >> "../$REPORT_FILE" 2>&1 || true
    cd ..
fi

# Docker image info
if command -v docker >/dev/null 2>&1; then
    echo "🔍 Checking Docker images..."
    echo "Docker Images:" >> "$REPORT_FILE"
    docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.CreatedAt}}" >> "$REPORT_FILE"
fi

echo "Scan completed: $REPORT_FILE" 